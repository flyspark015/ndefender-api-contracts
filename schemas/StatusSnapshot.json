{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "StatusSnapshot.json",
  "title": "Backend Aggregator StatusSnapshot",
  "type": "object",
  "additionalProperties": false,
  "required": ["timestamp_ms"],
  "properties": {
    "timestamp_ms": {"type": "integer", "minimum": 0},
    "overall_ok": {"type": "boolean"},
    "system": {"$ref": "./SystemStats.json"},
    "power": {"$ref": "./UPS_Telemetry.json"},
    "rf": {"$ref": "#/$defs/rf_state"},
    "remote_id": {"$ref": "#/$defs/remote_id_state"},
    "vrx": {"$ref": "#/$defs/vrx_state"},
    "fpv": {"$ref": "#/$defs/fpv_state"},
    "video": {"$ref": "#/$defs/video_state"},
    "services": {"type": "array", "items": {"$ref": "#/$defs/service_status"}},
    "network": {"$ref": "#/$defs/network_state"},
    "gps": {"$ref": "./GPSState.json"},
    "esp32": {"$ref": "./ESP32State.json"},
    "antsdr": {"$ref": "./AntSDRDeviceState.json"},
    "audio": {"$ref": "./AudioState.json"},
    "contacts": {"type": "array", "items": {"$ref": "./Contact.json"}},
    "replay": {"$ref": "#/$defs/replay_state"}
  },
  "$defs": {
    "service_status": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "active_state", "sub_state", "restart_count"],
      "properties": {
        "name": {"type": "string"},
        "active_state": {"type": "string"},
        "sub_state": {"type": "string"},
        "restart_count": {"type": "integer"},
        "uptime_s": {"type": "integer"},
        "last_restart_ms": {"type": "integer", "minimum": 0},
        "last_error": {"type": "string"}
      }
    },
    "network_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "connected": {"type": "boolean"},
        "ssid": {"type": "string"},
        "ip_v4": {"type": "string"},
        "ip_v6": {"type": "string"},
        "wifi": {"$ref": "./WifiState.json"},
        "bluetooth": {"$ref": "./BluetoothState.json"}
      }
    },
    "rf_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "status": {"type": "string", "enum": ["ok", "degraded", "offline", "unknown"]},
        "scan_active": {"type": "boolean"},
        "last_error": {"type": "string"},
        "last_event_type": {"type": "string"},
        "last_event": {"type": "object"},
        "last_timestamp_ms": {"type": "integer", "minimum": 0}
      }
    },
    "remote_id_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "state": {"type": "string", "enum": ["ok", "degraded", "offline", "replay"]},
        "mode": {"type": "string", "enum": ["live", "replay", "off"]},
        "capture_active": {"type": "boolean"},
        "contacts_active": {"type": "integer", "minimum": 0},
        "last_update_ms": {"type": "integer", "minimum": 0},
        "last_error": {"type": "string"},
        "last_event_type": {"type": "string"},
        "last_event": {"type": "object"},
        "last_timestamp_ms": {"type": "integer", "minimum": 0}
      }
    },
    "vrx_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "selected": {"type": "integer"},
        "scan_state": {"type": "string"},
        "vrx": {"type": "array", "items": {"$ref": "#/$defs/vrx_item"}},
        "led": {"$ref": "#/$defs/led_state"},
        "sys": {"$ref": "#/$defs/vrx_sys"}
      }
    },
    "fpv_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "selected": {"type": "integer"},
        "scan_state": {"type": "string"},
        "freq_hz": {"type": "number"},
        "rssi_raw": {"type": "integer"},
        "locked_channels": {"type": "array", "items": {"type": "integer"}}
      }
    },
    "vrx_item": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "freq_hz", "rssi_raw"],
      "properties": {
        "id": {"type": "integer"},
        "freq_hz": {"type": "number"},
        "rssi_raw": {"type": "integer"}
      }
    },
    "led_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "r": {"type": "integer"},
        "y": {"type": "integer"},
        "g": {"type": "integer"}
      }
    },
    "vrx_sys": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "uptime_ms": {"type": "integer"},
        "heap": {"type": "integer"},
        "status": {"type": "string"},
        "last_error": {"type": "string"}
      }
    },
    "video_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "selected": {"type": "integer"},
        "status": {"type": "string", "enum": ["ok", "offline", "unknown"]}
      }
    },
    "replay_state": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "active": {"type": "boolean"},
        "source": {"type": "string"}
      }
    }
  }
}
