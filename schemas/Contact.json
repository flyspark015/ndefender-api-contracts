{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "Contact.json",
  "title": "Unified Contact",
  "type": "object",
  "oneOf": [
    {"$ref": "#/$defs/remote_id_contact"},
    {"$ref": "#/$defs/rf_contact"},
    {"$ref": "#/$defs/fpv_contact"}
  ],
  "$defs": {
    "base": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "type", "source", "last_seen_ts", "severity"],
      "properties": {
        "id": {"type": "string", "minLength": 1},
        "type": {"type": "string"},
        "source": {"type": "string"},
        "last_seen_ts": {"type": "integer", "minimum": 0},
        "severity": {
          "type": "string",
          "enum": ["critical", "high", "medium", "low", "unknown"]
        }
      }
    },
    "remote_id_contact": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "id": {"type": "string", "minLength": 1},
            "type": {"const": "REMOTE_ID"},
            "source": {"const": "remoteid"},
            "last_seen_ts": {"type": "integer", "minimum": 0},
            "severity": {"type": "string"},
            "model": {"type": "string"},
            "operator_id": {"type": "string"},
            "lat": {"type": "number", "minimum": -90, "maximum": 90},
            "lon": {"type": "number", "minimum": -180, "maximum": 180},
            "altitude_m": {"type": "number"},
            "speed_m_s": {"type": "number", "minimum": 0}
          }
        }
      ]
    },
    "rf_contact": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "freq_hz",
            "bucket_hz",
            "band",
            "snr_db",
            "peak_db",
            "noise_floor_db",
            "bandwidth_class",
            "confidence",
            "features"
          ],
          "properties": {
            "id": {"type": "string", "minLength": 1},
            "type": {"const": "RF"},
            "source": {"const": "antsdr"},
            "last_seen_ts": {"type": "integer", "minimum": 0},
            "severity": {"type": "string"},
            "freq_hz": {"type": "number"},
            "bucket_hz": {"type": "number"},
            "band": {"type": "string"},
            "snr_db": {"type": "number"},
            "peak_db": {"type": "number"},
            "noise_floor_db": {"type": "number"},
            "bandwidth_class": {"type": "string"},
            "confidence": {"type": "number", "minimum": 0.0, "maximum": 1.0},
            "features": {"$ref": "#/$defs/rf_features"}
          }
        }
      ]
    },
    "rf_features": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "prominence_db",
        "cluster_size",
        "pattern_hint",
        "hop_hint",
        "bandwidth_est_hz",
        "burstiness",
        "hop_rate_hz",
        "control_score",
        "class_path",
        "classification_confidence",
        "control_correlation"
      ],
      "properties": {
        "prominence_db": {"type": "number"},
        "cluster_size": {"type": "integer", "minimum": 0},
        "pattern_hint": {"type": "string"},
        "hop_hint": {"type": "string"},
        "bandwidth_est_hz": {"type": "number", "minimum": 0.0},
        "burstiness": {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "hop_rate_hz": {"type": "number", "minimum": 0.0},
        "control_score": {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "class_path": {"type": "array", "items": {"type": "string"}},
        "classification_confidence": {"type": "number", "minimum": 0.0, "maximum": 1.0},
        "control_correlation": {"type": "boolean"}
      }
    },
    "fpv_contact": {
      "allOf": [
        {"$ref": "#/$defs/base"},
        {
          "type": "object",
          "additionalProperties": false,
          "required": ["vrx_id", "freq_hz", "rssi_raw", "selected"],
          "properties": {
            "id": {"type": "string", "minLength": 1},
            "type": {"const": "FPV"},
            "source": {"const": "esp32"},
            "last_seen_ts": {"type": "integer", "minimum": 0},
            "severity": {"type": "string"},
            "vrx_id": {"type": "integer"},
            "freq_hz": {"type": "number"},
            "rssi_raw": {"type": "integer"},
            "selected": {"type": "integer"}
          }
        }
      ]
    }
  }
}
