openapi: 3.1.0
info:
  title: N-Defender Unified API
  version: 1.0.0
servers:
  - url: /api/v1
paths:
  /health:
    get:
      summary: Health (service-specific)
      description: |-
        Health endpoint exists on Aggregator, System Controller, Observability, AntSDR Scan, and RemoteID Engine.
        Response shape varies by service (see oneOf).
      responses:
        "200":
          description: Health response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/AggregatorHealth"
                  - $ref: "#/components/schemas/SystemControllerHealth"
                  - $ref: "#/components/schemas/ObservabilityHealth"
                  - $ref: "#/components/schemas/AntsdrHealth"
                  - $ref: "#/components/schemas/RemoteIdStatus"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /status:
    get:
      summary: Status (service-specific)
      description: |-
        Status endpoint exists on Aggregator, System Controller, Observability, and RemoteID Engine.
      responses:
        "200":
          description: Status response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "../schemas/StatusSnapshot.json"
                  - $ref: "#/components/schemas/SystemControllerStatus"
                  - $ref: "#/components/schemas/ObservabilityStatus"
                  - $ref: "#/components/schemas/RemoteIdStatus"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /contacts:
    get:
      summary: Unified contacts (Aggregator)
      responses:
        "200":
          description: Contacts list
          content:
            application/json:
              schema:
                type: object
                properties:
                  contacts:
                    type: array
                    items:
                      $ref: "../schemas/Contact.json"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /system:
    get:
      summary: System stats
      responses:
        "200":
          description: System stats
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SystemStats"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /power:
    get:
      summary: UPS telemetry (Aggregator)
      responses:
        "200":
          description: UPS telemetry
          content:
            application/json:
              schema:
                $ref: "../schemas/UPS_Telemetry.json"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /ups:
    get:
      summary: UPS telemetry (System Controller)
      responses:
        "200":
          description: UPS telemetry
          content:
            application/json:
              schema:
                $ref: "../schemas/UPS_Telemetry.json"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /rf:
    get:
      summary: RF ingest state
      responses:
        "200":
          description: RF state
          content:
            application/json:
              schema:
                type: object
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /video:
    get:
      summary: Video state
      responses:
        "200":
          description: Video state
          content:
            application/json:
              schema:
                type: object
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /services:
    get:
      summary: Service status list
      responses:
        "200":
          description: Service list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ServiceStatus"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /network:
    get:
      summary: Network status
      responses:
        "200":
          description: Network status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/NetworkStatus"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /audio:
    get:
      summary: Audio status
      responses:
        "200":
          description: Audio status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AudioStatus"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /vrx/tune:
    post:
      summary: Tune VRX
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /scan/start:
    post:
      summary: Start scan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /scan/stop:
    post:
      summary: Stop scan
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /video/select:
    post:
      summary: Select video
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /system/reboot:
    post:
      summary: Reboot system
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /system/shutdown:
    post:
      summary: Shutdown system
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CommandRequest"
      responses:
        "200":
          description: Command result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CommandResult"
        "400":
          $ref: "#/components/responses/ErrorResponse"
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /ws:
    get:
      summary: WebSocket upgrade
      description: EventEnvelope stream over WS (see docs/WEBSOCKET_EVENTS.md)
      responses:
        "101":
          description: Switching Protocols
  /health/detail:
    get:
      summary: Observability health detail
      responses:
        "200":
          description: Health detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObservabilityHealthDetail"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /version:
    get:
      summary: Observability version
      responses:
        "200":
          description: Version
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ObservabilityVersion"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /config:
    get:
      summary: Observability config (sanitized)
      responses:
        "200":
          description: Config
          content:
            application/json:
              schema:
                type: object
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /metrics:
    get:
      summary: Prometheus metrics
      responses:
        "200":
          description: text/plain
  /diag/bundle:
    post:
      summary: Observability diagnostics bundle
      responses:
        "200":
          description: Bundle
          content:
            application/json:
              schema:
                type: object
        "403":
          $ref: "#/components/responses/ErrorResponse"
        "429":
          $ref: "#/components/responses/ErrorResponse"
        "500":
          $ref: "#/components/responses/ErrorResponse"
  /events/last:
    get:
      summary: AntSDR recent events
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: RF events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: "#/components/schemas/AntsdrEventEnvelope"
        "500":
          $ref: "#/components/responses/AntsdrErrorResponse"
  /events:
    get:
      summary: AntSDR WS endpoint (upgrade)
      responses:
        "101":
          description: Switching Protocols
  /run/start:
    post:
      summary: AntSDR start
      responses:
        "200":
          description: OK
        "409":
          $ref: "#/components/responses/AntsdrErrorResponse"
  /run/stop:
    post:
      summary: AntSDR stop
      responses:
        "200":
          description: OK
        "409":
          $ref: "#/components/responses/AntsdrErrorResponse"
  /run/replay:
    post:
      summary: AntSDR replay
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/AntsdrErrorResponse"
        "404":
          $ref: "#/components/responses/AntsdrErrorResponse"
        "409":
          $ref: "#/components/responses/AntsdrErrorResponse"
  /config/reload:
    post:
      summary: AntSDR reload config
      responses:
        "200":
          description: OK
        "409":
          $ref: "#/components/responses/AntsdrErrorResponse"
components:
  responses:
    ErrorResponse:
      description: Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    AntsdrErrorResponse:
      description: AntSDR error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/AntsdrErrorResponse"
  schemas:
    ErrorResponse:
      type: object
      additionalProperties: false
      properties:
        detail:
          type: string
    AntsdrErrorResponse:
      type: object
      additionalProperties: false
      properties:
        error:
          type: object
          additionalProperties: false
          properties:
            code: {type: string}
            message: {type: string}
    AntsdrEventEnvelope:
      type: object
      additionalProperties: false
      required: [type, timestamp_ms, source, data]
      properties:
        type: {type: string}
        timestamp_ms: {type: integer, minimum: 0}
        source: {type: string}
        data: {type: object}
    CommandRequest:
      type: object
      additionalProperties: false
      properties:
        payload:
          type: object
        confirm:
          type: boolean
      required: [payload, confirm]
    CommandResult:
      type: object
      additionalProperties: false
      required: [command, command_id, accepted, detail, timestamp_ms]
      properties:
        command: {type: string}
        command_id: {type: string}
        accepted: {type: boolean}
        detail:
          oneOf:
            - type: string
            - type: "null"
        timestamp_ms: {type: integer, minimum: 0}
    AggregatorHealth:
      type: object
      additionalProperties: false
      properties:
        status: {type: string}
        timestamp_ms: {type: integer, minimum: 0}
    SystemControllerHealth:
      type: object
      additionalProperties: false
      properties:
        ok: {type: boolean}
        timestamp_ms: {type: integer, minimum: 0}
        version: {type: string}
    ObservabilityHealth:
      type: object
      additionalProperties: false
      properties:
        status: {type: string}
    ObservabilityHealthDetail:
      type: object
      additionalProperties: false
      properties:
        generated_ts: {type: integer, minimum: 0}
        subsystems: {type: array, items: {type: object}}
        status: {type: string}
    ObservabilityStatus:
      type: object
      additionalProperties: false
      properties:
        generated_ts: {type: integer, minimum: 0}
        overall_state: {type: string}
        state_counts: {type: object}
        subsystems: {type: array, items: {type: object}}
    ObservabilityVersion:
      type: object
      additionalProperties: false
      properties:
        version: {type: string}
        git_sha: {type: string}
    AntsdrHealth:
      type: object
      additionalProperties: false
      properties:
        status: {type: string}
        engine_running: {type: boolean}
        ws_backend_connected: {type: boolean}
        last_event_timestamp_ms: {type: integer}
        timestamp_ms: {type: integer}
    RemoteIdStatus:
      type: object
      additionalProperties: false
      properties:
        state: {type: string}
        last_ts: {type: integer}
        contacts_active: {type: integer}
        mode: {type: string}
        updated_ts: {type: integer}
    SystemControllerStatus:
      type: object
      additionalProperties: false
      properties:
        timestamp_ms: {type: integer}
        system: {type: object}
        ups: {type: object}
        services: {type: array, items: {type: object}}
        network: {type: object}
        audio: {type: object}
    SystemStats:
      type: object
      additionalProperties: false
      properties:
        uptime_s: {type: integer}
        cpu_temp_c: {type: number}
        cpu_usage_percent: {type: number}
        load_1m: {type: number}
        load_5m: {type: number}
        load_15m: {type: number}
        ram_used_mb: {type: integer}
        ram_total_mb: {type: integer}
        disk_used_gb: {type: integer}
        disk_total_gb: {type: integer}
        throttled_flags: {type: integer}
        status: {type: string}
    ServiceStatus:
      type: object
      additionalProperties: false
      properties:
        name: {type: string}
        active_state: {type: string}
        sub_state: {type: string}
        restart_count: {type: integer}
    NetworkStatus:
      type: object
      additionalProperties: false
      properties:
        connected: {type: boolean}
        ssid: {type: string}
        ip_v4: {type: string}
        ip_v6: {type: string}
        status: {type: string}
    AudioStatus:
      type: object
      additionalProperties: false
      properties:
        volume_percent: {type: integer}
        muted: {type: boolean}
        status: {type: string}
